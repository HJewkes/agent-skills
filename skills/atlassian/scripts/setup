#!/usr/bin/env bash
set -euo pipefail

ENV_FILE="${HOME}/.atlassian-env"

# --- Colors ---

if command -v tput &>/dev/null && [[ -t 2 ]]; then
  GREEN=$(tput setaf 2)
  RED=$(tput setaf 1)
  BOLD=$(tput bold)
  RESET=$(tput sgr0)
else
  GREEN=""
  RED=""
  BOLD=""
  RESET=""
fi

# --- Helpers ---

info()    { echo "${BOLD}==> $*${RESET}" >&2; }
success() { echo "${GREEN}✓ $*${RESET}" >&2; }
fail()    { echo "${RED}✗ $*${RESET}" >&2; }
die()     { fail "$@"; exit 1; }

# --- Usage ---

usage() {
  cat <<'EOF'
Usage: setup [--help]

One-command onboarding for the Atlassian skill.

What it does:
  1. Installs jira-cli and jq via Homebrew (if missing)
  2. Collects Atlassian Cloud credentials
  3. Writes ~/.atlassian-env (mode 600)
  4. Configures jira-cli for your Atlassian Cloud instance
  5. Validates connectivity to Jira and Confluence
  6. Adds .atlassian-env to global gitignore

Prerequisites:
  - macOS with Homebrew installed
  - An Atlassian Cloud account
  - An API token from https://id.atlassian.com/manage/api-tokens

Options:
  --help    Show this help message

Exit codes:
  0  Setup completed successfully
  1  Setup failed
EOF
}

# --- Arg parsing ---

while [[ $# -gt 0 ]]; do
  case "$1" in
    --help) usage; exit 0 ;;
    *) echo "Unknown option: $1" >&2; usage >&2; exit 1 ;;
  esac
done

# --- Step 1: Check dependencies ---

info "Checking dependencies"

if ! command -v brew &>/dev/null; then
  die "Homebrew is required but not installed. See https://brew.sh"
fi

if ! command -v curl &>/dev/null; then
  die "curl is required but not found"
fi

if ! command -v jq &>/dev/null; then
  info "Installing jq via Homebrew"
  brew install jq
fi
success "jq available"

if ! command -v jira &>/dev/null; then
  info "Installing jira-cli via Homebrew"
  brew install ankitpokhrel/jira-cli/jira-cli
fi
success "jira-cli available"

# --- Step 2: Collect credentials ---

info "Configuring credentials"

if [[ -f "$ENV_FILE" ]]; then
  # shellcheck source=/dev/null
  source "$ENV_FILE"
  echo "  Existing config found: ${ATLASSIAN_DOMAIN:-<unset>}.atlassian.net (${ATLASSIAN_EMAIL:-<unset>})" >&2

  printf "  Reconfigure? [y/N] " >&2
  read -r answer
  if [[ "${answer,,}" != "y" ]]; then
    info "Keeping existing configuration"
  else
    unset ATLASSIAN_DOMAIN ATLASSIAN_EMAIL ATLASSIAN_API_TOKEN
  fi
fi

if [[ -z "${ATLASSIAN_DOMAIN:-}" ]]; then
  printf "  Atlassian domain (e.g. 'acme' for acme.atlassian.net): " >&2
  read -r ATLASSIAN_DOMAIN
  [[ -n "$ATLASSIAN_DOMAIN" ]] || die "Domain is required"
fi

if [[ -z "${ATLASSIAN_EMAIL:-}" ]]; then
  printf "  Atlassian email: " >&2
  read -r ATLASSIAN_EMAIL
  [[ -n "$ATLASSIAN_EMAIL" ]] || die "Email is required"
fi

if [[ -z "${ATLASSIAN_API_TOKEN:-}" ]]; then
  printf "  API token (from https://id.atlassian.com/manage/api-tokens): " >&2
  if read -rs ATLASSIAN_API_TOKEN 2>/dev/null; then
    echo >&2
  else
    read -r ATLASSIAN_API_TOKEN
  fi
  [[ -n "$ATLASSIAN_API_TOKEN" ]] || die "API token is required"
fi

# Write env file
cat > "$ENV_FILE" <<EOF
ATLASSIAN_DOMAIN=${ATLASSIAN_DOMAIN}
ATLASSIAN_EMAIL=${ATLASSIAN_EMAIL}
ATLASSIAN_API_TOKEN=${ATLASSIAN_API_TOKEN}
EOF
chmod 600 "$ENV_FILE"
success "Wrote ${ENV_FILE} (mode 600)"

# --- Step 3: Configure jira-cli ---

info "Configuring jira-cli"

export JIRA_API_TOKEN="$ATLASSIAN_API_TOKEN"
jira init \
  --installation cloud \
  --server "https://${ATLASSIAN_DOMAIN}.atlassian.net" \
  --login "$ATLASSIAN_EMAIL" \
  --force

success "jira-cli configured"

# --- Step 4: Validate connectivity ---

info "Validating connectivity"

jira_ok=false
confluence_ok=false

if jira me &>/dev/null; then
  jira_ok=true
  success "Jira: connected"
else
  fail "Jira: connection failed"
fi

confluence_response=$(curl -s -w "\n%{http_code}" \
  -u "${ATLASSIAN_EMAIL}:${ATLASSIAN_API_TOKEN}" \
  "https://${ATLASSIAN_DOMAIN}.atlassian.net/wiki/api/v2/spaces?limit=1")

confluence_http_code=$(echo "$confluence_response" | tail -1)
confluence_body=$(echo "$confluence_response" | sed '$d')

if [[ "$confluence_http_code" == "200" ]] && echo "$confluence_body" | jq -e '.results' &>/dev/null; then
  confluence_ok=true
  success "Confluence: connected"
else
  fail "Confluence: connection failed (HTTP ${confluence_http_code})"
fi

# --- Step 5: Global gitignore ---

info "Configuring global gitignore"

excludes_file=$(git config --global core.excludesfile 2>/dev/null || true)

if [[ -z "$excludes_file" ]]; then
  excludes_file="${HOME}/.config/git/ignore"
  mkdir -p "$(dirname "$excludes_file")"
  touch "$excludes_file"
  git config --global core.excludesfile "$excludes_file"
fi

# Expand ~ in case it's stored that way
excludes_file="${excludes_file/#\~/$HOME}"

if ! grep -qF '.atlassian-env' "$excludes_file" 2>/dev/null; then
  echo '.atlassian-env' >> "$excludes_file"
  success "Added .atlassian-env to ${excludes_file}"
else
  success ".atlassian-env already in ${excludes_file}"
fi

# --- Step 6: Summary ---

echo "" >&2
info "Setup complete"
echo "" >&2

masked_token="${ATLASSIAN_API_TOKEN:0:4}****"

echo "  Domain:     ${ATLASSIAN_DOMAIN}.atlassian.net" >&2
echo "  Email:      ${ATLASSIAN_EMAIL}" >&2
echo "  Token:      ${masked_token}" >&2
echo "  Env file:   ${ENV_FILE}" >&2
echo "" >&2

if $jira_ok; then
  echo "  ${GREEN}Jira:       connected${RESET}" >&2
else
  echo "  ${RED}Jira:       FAILED${RESET}" >&2
fi

if $confluence_ok; then
  echo "  ${GREEN}Confluence: connected${RESET}" >&2
else
  echo "  ${RED}Confluence: FAILED${RESET}" >&2
fi

echo "" >&2
echo "  Next steps:" >&2
echo "    jira issue list         # List Jira issues" >&2
echo "    confluence spaces       # List Confluence spaces" >&2
echo "" >&2

if ! $jira_ok || ! $confluence_ok; then
  die "Setup completed with connectivity errors — check credentials"
fi
