#!/usr/bin/env bash
set -euo pipefail

# verify-criteria â€” Run a list of verification commands and report pass/fail
#
# Usage: verify-criteria "cmd1" "cmd2" "cmd3"
#        verify-criteria --json "cmd1" "cmd2"
#
# Exit codes: 0 = all pass, 1 = any fail

usage() {
    cat <<'EOF'
Usage: verify-criteria [--json] "command1" "command2" ...

Run each command and report pass/fail.

Options:
  --json    Output results as JSON
  --help    Show this help

Exit codes:
  0  All commands passed
  1  One or more commands failed
EOF
}

json_escape() {
    local s="$1"
    s="${s//\\/\\\\}"
    s="${s//\"/\\\"}"
    s="${s//$'\n'/\\n}"
    printf '%s' "$s"
}

JSON_OUTPUT=false
COMMANDS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --json) JSON_OUTPUT=true; shift ;;
        --help) usage; exit 0 ;;
        --) shift; COMMANDS+=("$@"); break ;;
        -*) echo "Unknown option: $1" >&2; usage >&2; exit 1 ;;
        *) COMMANDS+=("$1"); shift ;;
    esac
done

if [[ ${#COMMANDS[@]} -eq 0 ]]; then
    echo "Error: No commands specified" >&2
    usage >&2
    exit 1
fi

PASS=0
FAIL=0
RESULT_STATUS=()
RESULT_CMD=()
RESULT_OUTPUT=()

for cmd in "${COMMANDS[@]}"; do
    # eval is intentional: commands may contain shell operators (pipes, redirects, &&)
    if output=$(eval "$cmd" 2>&1); then
        status="pass"
        PASS=$((PASS + 1))
    else
        status="fail"
        FAIL=$((FAIL + 1))
    fi
    RESULT_STATUS+=("$status")
    RESULT_CMD+=("$cmd")
    RESULT_OUTPUT+=("$output")
done

if $JSON_OUTPUT; then
    printf '{"total":%d,"passed":%d,"failed":%d,"results":[' "${#COMMANDS[@]}" "$PASS" "$FAIL"
    first=true
    for i in "${!RESULT_STATUS[@]}"; do
        status="${RESULT_STATUS[$i]}"
        cmd="${RESULT_CMD[$i]}"
        output="${RESULT_OUTPUT[$i]}"
        $first || printf ','
        first=false
        truncated=$(echo "$output" | head -5)
        printf '{"command":"%s","status":"%s","output":"%s"}' \
            "$(json_escape "$cmd")" \
            "$status" \
            "$(json_escape "$truncated")"
    done
    printf ']}\n'
else
    printf "\n## Verification Results\n\n"
    printf "| # | Status | Command |\n"
    printf "|---|--------|----------|\n"
    for i in "${!RESULT_STATUS[@]}"; do
        status="${RESULT_STATUS[$i]}"
        cmd="${RESULT_CMD[$i]}"
        if [[ "$status" == "pass" ]]; then
            indicator="PASS"
        else
            indicator="FAIL"
        fi
        printf "| %d | %s | \`%s\` |\n" "$((i + 1))" "$indicator" "$cmd"
    done
    printf "\n**%d passed, %d failed**\n" "$PASS" "$FAIL"

    if [[ $FAIL -gt 0 ]]; then
        printf "\n### Failures\n\n"
        for i in "${!RESULT_STATUS[@]}"; do
            status="${RESULT_STATUS[$i]}"
            cmd="${RESULT_CMD[$i]}"
            output="${RESULT_OUTPUT[$i]}"
            if [[ "$status" == "fail" ]]; then
                printf "**\`%s\`**:\n\`\`\`\n%s\n\`\`\`\n\n" "$cmd" "$(echo "$output" | head -20)"
            fi
        done
    fi
fi

[[ $FAIL -eq 0 ]]
