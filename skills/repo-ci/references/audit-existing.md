# Audit Existing Repo

Agent guide for `repo-ci` audit mode. Follow these steps in order.

## Step 1: Run the Audit

In the target repo directory:

```bash
repo-ci audit --json
```

Capture the full JSON output. Exit code 0 = all checks pass; exit code 2 = gaps found; exit code 1 = error.

## Step 2: Parse Results

The JSON output contains a `checks` array. Each check has:
- `area` — the category name
- `status` — `"pass"`, `"warn"`, or `"fail"`
- `message` — what was found or what's missing

The six areas checked are: `ci-workflow`, `release-workflow`, `formatter`, `coverage`, `branch-protection`, `security-scanning`.

## Step 3: Present Scorecard

Summarize results in a table before detailing any gaps:

```
| Area               | Status |
|--------------------|--------|
| CI workflow        | PASS   |
| Release workflow   | FAIL   |
| Formatter          | WARN   |
| Coverage           | PASS   |
| Branch protection  | WARN   |
| Security scanning  | PASS   |
```

State the overall score: `X/6 areas passing`.

## Step 4: Detail Gaps

For each `warn` or `fail` area, explain:

1. **What's missing** — repeat the message from the JSON output verbatim
2. **Why it matters** — reference the relevant section in [standards.md](standards.md)
3. **Specific fix** — the concrete action needed (e.g., add a job, create a file, enable a ruleset)

Reference guide for common gaps:

| Area | Common gap | Standards section |
|------|------------|-------------------|
| CI workflow | Missing gitleaks job or coverage upload | Universal Standards, Node/TypeScript CI Jobs |
| Release workflow | Missing version-verify step or provenance flag | Node/TypeScript Release Pipeline |
| Formatter | No Prettier config or missing `format:check` script | Node/TypeScript CI Jobs |
| Coverage | No thresholds set in vitest.config.ts | Coverage Thresholds |
| Branch protection | Rulesets not configured | Universal Standards |
| Security scanning | gitleaks not in CI | Universal Standards |

## Step 5: Handle Custom CI

Before flagging a gap, check whether the repo uses non-standard but functional CI:
- If `.github/workflows/` contains files not generated by `repo-ci`, read them first
- A custom workflow that achieves the same result (e.g., uses a different secret scanner) is not a gap
- Only flag areas where the function is genuinely absent, not just implemented differently
- Note any custom patterns so the user knows they won't be overwritten

## Step 6: Offer to Fix

If any `warn` or `fail` areas were found, offer:

> "I can run `repo-ci setup` to generate the missing pieces. Want me to preview what it will create first with `--dry-run`?"

If the user agrees, proceed to [setup-new.md](setup-new.md) setup flow.

## Step 7: Post-Fix Verification

After any fixes are applied, re-run the audit to confirm:

```bash
repo-ci audit
```

Present the updated scorecard and confirm all previously failing areas now pass. If any remain, explain why (e.g., branch protection rulesets must be configured in GitHub UI and cannot be auto-fixed by the script).
